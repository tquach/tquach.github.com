'use strict';
var isTouchDevice = navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|Windows Phone)/);

$(window).on('load', function() {});

$(document).ready(function() {
    // PRELOADER
    var $preloader = $('.page-preloader'),
        $spinner = $preloader.find('.spinner');
    $spinner.fadeIn();
    $spinner.fadeOut();
    $preloader.delay(300).fadeOut('slow');

    if (!isTouchDevice) {
        $('body').addClass('no-touch')
    }

    //add array of menu
    var arrayMenuAnchor = [];
    // var scrollClassSection = 'scrollSection';
    var duration = 300;
    var sectionDelay = 0;
    var globalDelay = 0;
    var fullPageDesctop;

    //function for fullPage plugin
    if ($('.fullpage').length) {
        $('.fullpage').fullpage({
            menu: '.section-menu',
            anchors: arrayMenuAnchor,
            /*scrollingSpeed: 300,*/
            navigation: false,
            scrollOverflow: false,
            css3: false,
            verticalCentered: false,
            sectionSelector: 'section',
            responsive: 768,
            afterLoad: function(anchorLink, index) {
                sectionDelay = 300;
                $(this).find('[data-animation-delay]').each(function() {
                    sectionDelay = Math.max(sectionDelay, $(this).attr('data-animation-delay'))
                    globalDelay = duration + sectionDelay;
                })

                if ($(window).width() >= 768) {
                    setTimeout(function() {
                        $('section.active')
                            .css({
                                visibility: 'visible'
                            })
                            .animate({
                                opacity: 1
                            }, 300);

                        animateStart();

                    }, globalDelay + 200)
                }
            },

            onLeave: function(index, nextIndex, direction) {
                if ($(window).width() >= 768) {
                    setTimeout(function() {
                        animateFinish();
                    }, 0)


                    $(this).find('[data-out-animation-delay]').each(function() {
                        sectionDelay = Math.max(sectionDelay, $(this).attr('data-out-animation-delay'))
                        globalDelay = duration + sectionDelay;
                    });

                    setTimeout(function() {
                        $('section').each(function() {
                            if (!$(this).hasClass('active')) {
                                $(this)
                                    .animate({
                                        opacity: 0
                                    }, 300)
                                    .delay(350)
                                    .css({
                                        visibility: 'hidden'
                                    });
                            };
                        })
                    }, globalDelay + 200)

                    $('main').css({
                        "-webkit-transition": "top 0ms ease " + globalDelay + "ms",
                        "-o-transition": "top 0ms ease " + globalDelay + "ms",
                        "transition": "top 0ms ease " + globalDelay + "ms"
                    });
                };
            },

            afterRender: function() {
                if ($(window).width() >= 768) {
                    $('section.active [data-animation]').each(function() {
                        $(this).addClass('animated');
                    });

                    fullPageDesctop = true;

                    var footer = $('footer')[0].innerHTML;
                    $('footer').css({
                        opacity: 0
                    });

                    $("section").append(footer);
                    $('.section-content').append('<div class="border-top"></div>');
                    $('.section-content').append('<div class="border-bottom"></div>');

                    $('section').each(function() {

                        /*$(this).css({
                          height: '100%'
                        })*/
                        var HSC = function(elem) {
                            if (elem.find('.share').length > 0) {
                                return 36;
                            } else {
                                return 0;
                            }
                        }

                        $(this).find('.section-content-wrapper')
                            .css({
                                paddingTop: '50px',
                                paddingBottom: '50px',
                                overflow: 'hidden',
                                display: 'table',
                                height: $(window).height() - 120 - 120 - HSC($(this)),
                            });
                    })
                } else {
                    $('[data-animation]').each(function() {
                        $(this).removeClass($(this).data('animation'));
                    });

                    fullPageDesctop = false;

                    $('section').each(function() {
                        $(this).css({
                            height: 'auto'
                        })
                    })

                    $('.section-content-wrapper').each(function() {
                        $(this).css({
                            paddingTop: '0px',
                            paddingBottom: '0px',
                            marginBottom: '0px',
                            height: 'auto'
                        })
                    })
                }

                // setTimeout(function() {
                //     scrollSection($('section'));
                // }, 300)
            },

            afterResize: function() {
                $('section').each(function() {

                    /*$(this).css({
                      height:'100%'
                    })*/
                })
                if ($(window).width() >= 768) {
                    setTimeout(function() {
                        $('body').css('height', '')
                    }, 400)

                    $('[data-animation]').each(function() {
                        $(this).addClass('animated');
                    });

                    if (fullPageDesctop == false) {

                        fullPageDesctop = true;

                        $('section')
                            .css({
                                visibility: 'hidden'
                            })
                            .animate({
                                opacity: 0
                            }, 1);

                        $('section.active')
                            .css({
                                visibility: 'visible'
                            })
                            .animate({
                                opacity: 1
                            }, 300);

                        $('.section-content').append('<div class="border-top"></div>');
                        $('.section-content').append('<div class="border-bottom"></div>');

                        borderWr();

                        var footer = $('footer')[0].innerHTML;
                        $("section").append(footer);

                        $('footer').animate({
                            opacity: 0
                        }, 1);

                        animateFinish();
                        animateStart();
                    }

                    $('section').each(function() {
                        var HSC = function(elem) {
                            if (elem.find('.share').length > 0) {
                                return 33;
                            } else {
                                return 0;
                            }
                        }

                        $(this).find('.section-content-wrapper')
                            .css({
                                paddingTop: '50px',
                                paddingBottom: '50px',
                                overflow: 'hidden',
                                display: 'table',
                                height: $(window).height() - 120 - 120 - HSC($(this)),
                            });
                    })
                } else if ($(window).width() < 768) {
                    $('[data-animation]').each(function() {
                        $(this).removeClass('animated');
                    })

                    $('section').each(function() {
                        $(this).css({
                            height: 'auto'
                        })
                    })

                    $('.section-content-wrapper').css({
                        paddingTop: '0px',
                        paddingBottom: '0px',
                        marginBottom: '0px',
                        height: 'auto'
                    })

                    $('section, footer').animate({
                        opacity: 1
                    }, 1);
                    $('section').css({
                        visibility: 'visible'
                    })

                    if (fullPageDesctop == true) {

                        fullPageDesctop = false;

                        $('.border-top, .border-bottom').remove();
                        $("section .copyright").remove();
                    };
                }

                // setTimeout(function() {
                //     scrollSection($('section'))
                // }, 300)
            }
        });
    }
    retina();
});

//Animate Start
function animateStart() {
    $('section.active').find('[data-animation]').each(function() {

        var $this = $(this),
            animation = 'fadeIn',
            delay = 1;

        if ($this.data('animation')) {
            animation = $this.data('animation');
        }

        if ($this.data('animationDelay')) {
            delay = $this.data('animationDelay');
        }

        if ($this.closest('section').hasClass('active')) {
            $this.css('animation-delay', delay + 'ms').addClass('animated').addClass(animation);
        }
    });
}

//Animate Finish
function animateFinish() {
    var activeSection = $('section.active'),
        duration = 1;

    $('[data-out-animation]').each(function() {
        var $this = $(this),
            animation = 'fadeIn',
            outAnimation = 'fadeOut',
            delay = 1,
            outDelay = 1;

        if ($this.data('animation')) {
            animation = $this.data('animation');
        }

        if ($this.data('outAnimation')) {
            outAnimation = $this.data('outAnimation');
        }

        if ($this.data('animationDelay')) {
            delay = $this.data('animationDelay');
        }

        if ($this.data('outAnimationDelay')) {
            outDelay = $this.data('outAnimationDelay');
        }

        $this.css('animation-delay', delay + 'ms');



        if (!$this.closest('section').hasClass('active')) {

            if (outDelay >= duration) {
                duration = outDelay;
            }

            $this.removeClass(animation).addClass(outAnimation);

            if ($this.data('outAnimationDelay')) {
                $this.css('animation-delay', outDelay + 'ms');
            } else {
                $this.css('animation-delay', '1ms');
            }
        } else {
            $this.removeClass(animation).removeClass(outAnimation).removeAttr('style', 'animation-delay');
        }
    });
}

function retina() {

    if ('devicePixelRatio' in window && window.devicePixelRatio == 2) {

        var imgToReplace = $('img.replace-2x').get();

        for (var i = 0, l = imgToReplace.length; i < l; i++) {
            var src = imgToReplace[i].src;
            src = src.replace(/\.(png|jpg|gif)+$/i, '@2x.$1');
            imgToReplace[i].src = src;
            $(imgToReplace[i]).load(function() {
                $(this).addClass('loaded');
            });
        };

        var imgToReplaceM = $('a.replace-2x').get();

        for (var i = 0, l = imgToReplaceM.length; i < l; i++) {
            var src = imgToReplaceM[i].href;
            src = src.replace(/\.(png|jpg|gif)+$/i, '@2x.$1');
            imgToReplaceM[i].href = src;
            $(imgToReplaceM[i]).addClass('loaded');
        };

        $('img').each(function() {
            var item = $(this);
            var retinaSrc = $(this).attr('data-retina-src');

            if (retinaSrc !== undefined) {
                item.attr('src', retinaSrc);
            }
        });

    }
}